---
title: "AWS Lambda ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ PostgreSQL ã«æ¥ç¶šã™ã‚‹"
emoji: "ğŸ"
type: "tech"
topics: ["Python", "AWS Lambda"]
published: false
---

# ã¯ã˜ã‚ã«

AWS Lambda ã‹ã‚‰ Python ã‚’ä½¿ã£ã¦ PostgreSQL ã«æ¥ç¶šã™ã‚‹ã¨ãã«ã€ `psycopg2` ã‚’ä½¿ã†ã“ã¨ãŒå¤šã„ã¨æ€ã„ã¾ã™ã€‚

ãã®å ´åˆã€ZIP ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¦ Lambda ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»Šã¾ã§ã¯ã€ Serverless Framework ã‚’ä½¿ã£ãŸã‚Šã€ [`lambci/docker-lambda`](https://github.com/lambci/docker-lambda) ã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¦ã„ã¾ã—ãŸã€‚

æ™®æ®µã€ Terraform ã‚’ä½¿ã£ã¦ Lambda ãªã©ã®ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹éš›ã«ã€ ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã‚’äºˆã‚ãƒªãƒã‚¸ãƒˆãƒªã«å…¥ã‚Œã‚‰ã‚Œã°å®¹æ˜“ã§ã™ãŒã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã„å ´åˆãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã« ZIP ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ã™ã‚‹ã®ãŒé¢å€’ã§ã™ã€‚

ãã“ã§ã€ AWS Lambda ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ PostgreSQL ã«æ¥ç¶šã™ã‚‹æ–¹æ³•ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

# æº–å‚™

## AWS Lambda ã‚¤ãƒ¡ãƒ¼ã‚¸

AWS Lambda ã®ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒ ECR ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ `psycopg2` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚

- [lambda/python](https://gallery.ecr.aws/lambda/python)

# ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä½œæˆ

## Dockerfile

æ¬¡ã®ã‚ˆã†ãª Dockerfile ã‚’ä½œæˆã—ã¾ã™ã€‚

ã“ã® Dockerfile ã§ã¯ã€ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® AWS Lambda ã® Pythonã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆ `public.ecr.aws/lambda/python:3.11.2023.11.01.21-x86_64` ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
x86_64 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ Lambda é–¢æ•°ã‚’å®Ÿè¡Œã—ãŸã‹ã£ãŸã®ã§ç‰¹å®šã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’é¸æŠã—ã¾ã—ãŸã€‚

```Dockerfile
FROM public.ecr.aws/lambda/python:3.11.2023.11.01.21-x86_64
ENV PGVERSION 13.13

RUN yum update -y \
  && yum install -y tar gzip gcc python3-devel python3-pip python3-setuptools libxml2-devel libxslt-devel readline-devel uuid-devel openssl \
  && yum clean all

RUN curl -O https://ftp.postgresql.org/pub/source/v${PGVERSION}/postgresql-${PGVERSION}.tar.gz \
  && tar -xvf postgresql-${PGVERSION}.tar.gz \
  && cd postgresql-${PGVERSION} \
  && ./configure \
  && make -j4 \
  && make install \
  && cd .. \
  && rm -rf postgresql-${PGVERSION} postgresql-${PGVERSION}.tar.gz

COPY src/*.py $LAMBDA_TASK_ROOT
COPY src/requirements.txt $LAMBDA_TASK_ROOT

RUN pip install --upgrade pip \
  && pip install -r requirements.txt

CMD ["handler.main"]
```

AWS Lambda ã®æ¨™æº–ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¯ PostgreSQL 13 ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå«ã¾ã‚Œã¦ã„ãªã„ãŸã‚ã€ [ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰](https://www.postgresql.org/ftp/source/) ã‹ã‚‰ç›´æ¥ãƒ“ãƒ«ãƒ‰ã—ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚
ã“ã®æ–¹æ³•ã¯ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¦ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚‹å ´åˆã«åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

requirements.txt ã«ã¯ã€ `psycopg2` ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

```
psycopg2-binary
```

# ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨æ›´æ–°

ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ ECR ã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã® Makefile ã‚’ä½œæˆã—ã¾ã™ã€‚

`latest` ã‚¿ã‚°ã§ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã‚‰ã€ Lambda é–¢æ•°ã®æ›´æ–°ã•ã‚Œã‚‹ã¨æ€ã£ãŸã®ã§ã™ãŒè‡ªå‹•ã§ã¯æ›´æ–°ã•ã‚Œã¾ã›ã‚“ã€‚
`aws lambda update-function-code` ã‚’å®Ÿè¡Œã—ã¦æ˜ç¤ºçš„ã« image-uri ã‚’æŒ‡å®šã—ã¦æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ECR ã«ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã¨ãã« Lambda é–¢æ•°ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã« [update-function-code](https://docs.aws.amazon.com/cli/latest/reference/lambda/update-function-code.html) ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## Makefile

```Makefile
APP_NAME = lambda/lambda-postgresql
FUNCTION_NAME = lambda-postgresql-sandbox
APP_VERSION ?=

AWS_ECR_ACCOUNT_ID ?=
AWS_ECR_REGION ?=
AWS_ECR_REPO = $(APP_NAME)

TAG ?= latest


.PHONY : docker/build docker/push docker/run/bash

docker/build :
	docker build -t $(APP_NAME):$(APP_VERSION) .


docker/push : docker/build
	aws ecr get-login-password --region $(AWS_ECR_REGION) | docker login --username AWS --password-stdin $(AWS_ECR_ACCOUNT_ID).dkr.ecr.$(AWS_ECR_REGION).amazonaws.com
	docker tag $(APP_NAME):$(APP_VERSION) $(AWS_ECR_ACCOUNT_ID).dkr.ecr.$(AWS_ECR_REGION).amazonaws.com/$(AWS_ECR_REPO):$(TAG)
	docker push $(AWS_ECR_ACCOUNT_ID).dkr.ecr.$(AWS_ECR_REGION).amazonaws.com/$(AWS_ECR_REPO):$(TAG)
	aws lambda update-function-code --function-name $(FUNCTION_NAME) --image-uri $(AWS_ECR_ACCOUNT_ID).dkr.ecr.$(AWS_ECR_REGION).amazonaws.com/$(AWS_ECR_REPO):$(TAG) --publish || true
```

Makefile ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€è¤‡æ•°ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å«ã‚€ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚’å˜ä¸€ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã§ãã¾ã™ã€‚
ã“ã®æ–¹æ³•ã¯ã€ãƒ“ãƒ«ãƒ‰ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ã‚’æ¨™æº–åŒ–ã— CD ã‚’å®Ÿç¾ã™ã‚‹éš›ã«ã‚‚æœ‰ç”¨ã§ã™ã€‚

## å®Ÿè¡Œä¾‹

ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œ ECR ã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã™ã€‚
åŒæ™‚ã« Lambda é–¢æ•°ãŒæ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã®ã§ã€ã‹ãªã‚Šæ›´æ–°ãŒæ¥½ã«ãªã‚Šã¾ã™ã€‚

```bash
$ export AWS_ACCESS_KEY_ID="ASIxxx"
export AWS_SECRET_ACCESS_KEY="Aooxxx"
export AWS_SESSION_TOKEN="IQoxxx"

$ make docker/push AWS_ECR_ACCOUNT_ID=123456789012 AWS_ECR_REGION=ap-northeast-1 APP_VERSION=latest
```

# Lambda é–¢æ•°ã®ä¸­èº«ã¨å®Ÿè¡Œ

ã‚³ãƒ³ãƒ†ãƒŠå†…ã«å®Ÿè¡Œã™ã‚‹ä»¥ä¸‹ã® Python ã®ã‚³ãƒ¼ãƒ‰ã‚’é…ç½®ã—ã¦ã„ã¾ã™ã€‚
ä¸­èº«ã¯ã€ `psycopg2` ã‚’ä½¿ã£ã¦ PostgreSQL ã«æ¥ç¶šã—ã¦ã€ `information_schema.columns` ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«åã¨ã‚«ãƒ©ãƒ åã‚’å–å¾—ã—ã¦ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¾ã™ã€‚

```python
import logging
import os

import psycopg2

logger = logging.getLogger()
logger.setLevel(logging.INFO)


def execute_sql(database_url, sql):
  rows = None
  with psycopg2.connect(database_url) as conn:
    with conn.cursor() as cursor:
      cursor.execute(sql)
      if 'SELECT' in cursor.statusmessage:
        rows = cursor.fetchall()
  return rows


def column_all_sql():
  return """
    SELECT
      c.table_name,
      c.column_name
    FROM
      information_schema.columns AS c
    WHERE
      c.table_schema = 'public'
    ORDER BY
      c.table_name,
      c.column_name;
  """


def main(event, context):
  logger.info(event)

  database_url = os.environ.get('DATABASE_URL')

  if database_url is None:
    raise Exception('Not found DATABASE_URL environment value')

  rows = execute_sql(database_url, column_all_sql())
  logger.info(rows)
  logger.info(rows[0])
```

Lambda é–¢æ•°ã¨ PostgreSQL ã®é–“ã®ã‚»ã‚­ãƒ¥ã‚¢ãªæ¥ç¶šã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã¯ã€ Secret Manager ã‚’é€šã˜ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã‚’æ¸¡ã™ã»ã†ãŒã‚ˆã„ã§ã™ã€‚
ä»Šå›ã€ç°¡å˜ã®ãŸã‚ã«ç’°å¢ƒå¤‰æ•°ã«ç›´æ¥æ¥ç¶šæƒ…å ±ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚

## å®Ÿè¡Œãƒ­ã‚°

ä»Šå› RDS ã« PostgreSQL 13 ã‚’èµ·å‹•ã—ã¦ [dvdrental](https://www.postgresqltutorial.com/postgresql-getting-started/postgresql-sample-database/) ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚
DATABASE_URL ã«ã¯ã€ ãã®ä½œæˆã—ãŸ RDS ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®è¨­å®šãªã©ã¯ã€é©å®œè¡Œã£ã¦ãã ã•ã„ã€‚

lambda å®Ÿè¡Œã—ã¦ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ†ãƒ¼ãƒ–ãƒ«åã¨ã‚«ãƒ©ãƒ åãŒå–å¾—ã§ãã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

```
[INFO]	2023-11-25T16:46:38.195Z	fa465df2-479f-45f7-9827-d60d37d11857	[('actor', 'actor_id'), ('actor', 'first_name'), ('actor', 'last_name'), ('actor', 'last_update') ...
[INFO] 2023-11-25T16:46:38.195Z fa465df2-479f-45f7-9827-d60d37d11857 ('actor', 'actor_id')
```

å®Ÿéš›ã«ä½œæˆã—ãŸã‚‚ã®ã¯ä»¥ä¸‹ã«ã‚ã‚Šã¾ã™ã€‚

- [lambda-postgresql](https://github.com/mani3/lambda-postgresql)

# ã¾ã¨ã‚

AWS Lambda ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ PostgreSQL ã«æ¥ç¶šã™ã‚‹æ–¹æ³•ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
Terraform ã®ç’°å¢ƒæ§‹ç¯‰ã¨ Lambda é–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’åˆ†ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ä¾¿åˆ©ã ã¨æ€ã„ã¾ã—ãŸã€‚
